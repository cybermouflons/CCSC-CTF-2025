<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Blackjack</title>
		<link rel="icon" type="image/x-icon" href="static/favicon.ico">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<style type="text/css">
			.cards-wrapper {
				min-height: 146px;
				background-color: #005a004d;
				border-radius: 8px;
				padding: 10px 15px;
			}

			.cards-wrapper {
				position: relative;
			}
			.cards-wrapper img {
				margin-right: 5px;
			}
			.cards-wrapper .info {
				position: absolute;
				top: 5px;
				right: 10px;
				font-weight: bold;
			}
			.cards-wrapper .result {
				position: absolute;
				top: 50%;
				margin-top: -20px;
				line-height: 40px;
				font-size: 36px;
				right: 25px;
				font-weight: bold;
			}
			.actions-wrapper button {
				margin-bottom: 5px;
			}

			.tab-pane > .card:first-child {
				border-top: 0px;
				border-top-right-radius: 0;
				border-top-left-radius: 0;
				margin-top: 0!important;
				border-color: #dee2e6;
			}
		</style>
	</head>
	<body>
		
		<div class="container">
			<h1 class="my-2"><i class="fa-solid fa-diamond"></i> Blackjack</h1>

			<nav>
				<div class="nav nav-tabs" id="nav-tab" role="tablist">
				<button class="nav-link active" id="nav-game-tab" data-bs-toggle="tab" data-bs-target="#nav-game" type="button" role="tab" aria-controls="nav-game" aria-selected="true"><i class="fa-solid fa-heart"></i> Game</button>
				<button class="nav-link" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button" role="tab" aria-controls="nav-info" aria-selected="false"><i class="fa-solid fa-circle-info"></i> Challenge Info</button>
				</div>
			</nav>
			<div class="tab-content" id="nav-tabContent">

				<!-- Game -->
				<div class="tab-pane fade show active" id="nav-game" role="tabpanel" aria-labelledby="nav-game-tab">
					<div class="card my-2">
						<div class="card-body">
							<div class="row">
								<div class="col">
									<h4><i class="fa-solid fa-robot"></i> Dealer <small id="blackjack-dealer-balance"></small></h4>
									<div id="blackjack-dealer-cards" class="cards-wrapper"></div>
									<br>
									<h4><i class="fa-solid fa-user"></i> Player <small id="blackjack-player-balance"></small></h4>
									<div id="blackjack-player-cards" class="cards-wrapper"></div>
								</div>
								<div class="col actions-wrapper">
									<h4><i class="fa-solid fa-bolt"></i> Game Actions</h4>
									<div id="blackjack-game-status" class="alert alert-info" role="alert">Waiting game to start. Place your bet.</div>

									<button class="btn btn-success btn-lg" id="blackjack-bet" title="BET: Start a new game."><i class="fa-solid fa-coins"></i></button> 
									<button class="btn btn-primary btn-lg" id="blackjack-hit" title="HIT: Draw a new card."><i class="fa-regular fa-hand-back-fist"></i></button> 
									<button class="btn btn-secondary btn-lg" id="blackjack-stand" title="STAND: Stop here and let the dealer draw."><i class="fa-regular fa-hand"></i></button> 
									<button class="btn btn-warning btn-lg" id="blackjack-double" title="DOUBLE: Double the bet and draw a new card."><i class="fa-solid fa-arrow-up"></i></button> 
									<button class="btn btn-danger btn-lg" id="blackjack-forfeit" title="FORFEIT: Forfeit the game."><i class="fa-solid fa-xmark"></i></button> 
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Blockchain and Challenge info -->
				<div class="tab-pane fade" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab">
					<div class="card my-2">
						<div class="card-body">
							A blockchain network is running on this server:<br>
							RPC URL <code><script type="text/javascript">document.write(new URL(window.location.href).origin + "/blockchain");</script></code> ,
							Chain Id <code>0x{{ ganache_options.chain.chainId.toString(16) }}</code> ,
							Currency Symbol <code>ETH</code> ,
							Gas Limit <code>{{ ganache_info.gasLimit }} wei</code>
							<br>
							<br>
							On this page, <a href="https://web3js.readthedocs.io/en/v1.7.5/" target="_blank">web3.js</a> is already loaded and connected to the blockchain.
						</div>
					</div>
					
					<div class="card my-2">
						<div class="card-body">
							The wallet with the address:<br>
							<code>{{ server_wallet.address }}</code><br>
							deployed a smart contract at the following address:<br>
							<code>{% if contract_info.address %}{{ contract_info.address }}{% else %}loading ...{% endif %}</code><br>
							{% if contract_info.abi_string and contract_info.address %}The contract is also loaded as a Web3 Contract on the global variable <code>contract</code><br>{% endif %}
							<br>
							In case you need them, here are the smart contract files:
							<ul>
								<li><a href="static/{{ contract_info.filename_sol }}">{{ contract_info.filename_sol }}</a></li>
								{% if contract_info.libs_import %}
									{% for lib_name, lib_path in contract_info.libs_import %}
										<li><a href="static/{{ lib_path }}">{{ lib_name }}</a></li>
									{% endfor %}
								{% endif %}
								<li><a href="static/{{ contract_info.filename_bin }}">{{ contract_info.filename_bin }}</a></li>
								<li><a href="static/{{ contract_info.filename_abi }}">{{ contract_info.filename_abi }}</a></li>
							</ul>
						</div>
					</div>
					
					<div class="card my-2">
						<div class="card-body">
							Your goal is to win multiple times in the Blackjack, turning the smart contract's balance to <code>zero</code>.<br>
							<div class="mt-2">
								<button class="btn btn-primary btn-sm" id="check-if-solved">Click here to check if solved</button>
								<small><code id="check-if-solved-response">Click the button if you think you solved the challenge.</code></small>
							</div>
						</div>
					</div>
					
					<div class="card my-2">
						<div class="card-body">
							In case you need a wallet, you may use the following:<br>
							Address <code>{{ client_wallet.address }}</code><br>
							Private Key <code>{{ client_wallet.privateKey }}</code><br>
							Mnemonic Seed <code>{{ client_wallet.mnemonic }}</code><br>
							{% if client_wallet.privateKey %}The account is also added on the Web3 wallet and is available through the global variable <code>account</code><br>{% endif %}
						</div>
					</div>
					
					<div class="alert alert-warning my-2" role="alert">
						This challenge has it's own blockchain test network. If you do own cryptocurrencies please be careful not to transfer real world currencies by mistake. 
					</div>
				</div>
			</div>
			
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/web3@1.7.5/dist/web3.min.js" integrity="sha384-g132Mel5Vo4bK8fotc1/Q+MuJxIeFZ+sUZ/kyb1/XMrVzQk+kNH2Sh2nSbMzjGpX" crossorigin="anonymous"></script>
		<script type="text/javascript">
			console.warn(
`
  ____  _            _     _            _    
 | __ )| | __ _  ___| | __(_) __ _  ___| | __
 |  _ \\| |/ _\` |/ __| |/ /| |/ _\` |/ __| |/ /
 | |_) | | (_| | (__|   < | | (_| | (__|   < 
 |____/|_|\\__,_|\\___|_|\\_\\/ |\\__,_|\\___|_|\\_\\
                        |__/                 
`
			);
			
			// Connect to the blockchain
			window.web3 = new Web3(
				new Web3.providers.HttpProvider(
					new URL(window.location.href).origin + "/blockchain"
				)
			);
			console.warn('[Challenge] Web3 Provider was loaded on variable "web3".');

			{% if contract_info.abi_string and contract_info.address %}
			// Create a reference to the contract
			window.contract = new window.web3.eth.Contract({{ contract_info.abi_string | safe }}, "{{ contract_info.address }}");
			console.warn('[Challenge] Contract was loaded on variable "contract".');
			{% endif %}

			{% if client_wallet.privateKey %}
			// Add account on wallet
			window.account = web3.eth.accounts.privateKeyToAccount('{{ client_wallet.privateKey }}');
			window.web3.eth.accounts.wallet.add(window.account);
			console.warn('[Challenge] Account was loaded on variable "account".');
			{% endif %}
		</script>
		<script type="text/javascript">
			(() => {
				let status = document.getElementById('check-if-solved-response');
				document.getElementById('check-if-solved').addEventListener('click', function() {
					status.textContent = 'Loading ...';
					fetch('/check', {method: 'GET'})
					.then((response) => response.json())
					.then((data) => {
						if (data.error) {
							status.textContent = data.error;
						}
						else {
							status.textContent = data.success;
						}
					})
					.catch((error) => {
						status.textContent = 'Error. Failed to check if challenge was solved.';
					});
				}, false);
			})();
		</script>

		<script type="text/javascript">
			// UI Game
			let blackjack = {

				dealerCards : [],
				playerCards : [],
				wrappers : {},
				running : false,

				init : async function () {
					this.wrappers.dealerBalance = document.getElementById('blackjack-dealer-balance');
					this.wrappers.playerBalance = document.getElementById('blackjack-player-balance');
					this.wrappers.dealerCards = document.getElementById('blackjack-dealer-cards');
					this.wrappers.playerCards = document.getElementById('blackjack-player-cards');
					this.wrappers.bet = document.getElementById('blackjack-bet');
					this.wrappers.hit = document.getElementById('blackjack-hit');
					this.wrappers.stand = document.getElementById('blackjack-stand');
					this.wrappers.double = document.getElementById('blackjack-double');
					this.wrappers.forfeit = document.getElementById('blackjack-forfeit');
					this.wrappers.status = document.getElementById('blackjack-game-status');

					this.wrappers.bet.addEventListener('click', () => {this.bet();});
					this.wrappers.hit.addEventListener('click', () => {this.hit();});
					this.wrappers.stand.addEventListener('click', () => {this.stand();});
					this.wrappers.double.addEventListener('click', () => {this.double();});
					this.wrappers.forfeit.addEventListener('click', () => {this.forfeit();});

					this.running = false;

					await this.showBalance();
					this.balance = this.new_balance;
				},

				bet : async function(amount=0) {
					if (!amount) {
						amount = prompt('Ether to bet:', '0.001');
						if (!amount) return;
						amount = Web3.utils.toWei(amount, 'ether');
					}
					try {
						this.bet_amount = amount;
						let method = contract.methods.bet();
						let gasNeeded = await method.estimateGas();
						let result = await method.send({
							from: account.address,
							value: amount,
							gas: Math.round(gasNeeded * 2)
						});
						await this.update(true);
					} catch (e) {
						this.wrappers.status.textContent = 'Failed to execute "bet".';
						await this.update();
					}
				},

				hit : async function() {
					try {
						let method = contract.methods.hit();
						let gasNeeded = await method.estimateGas();
						let result = await method.send({
							from: account.address,
							gas: Math.round(gasNeeded * 2)
						});
					} catch (e) {
						this.wrappers.status.textContent = 'Failed to execute "hit".';
					}

					await this.update();
				},

				stand : async function() {
					try {
						let method = contract.methods.stand();
						let gasNeeded = await method.estimateGas();
						let result = await method.send({
							from: account.address,
							gas: Math.round(gasNeeded * 2)
						});
					} catch (e) {
						this.wrappers.status.textContent = 'Failed to execute "stand".';
					}

					await this.update();
				},

				double : async function() {
					try {
						let method = contract.methods.double();
						let gasNeeded = await method.estimateGas();
						let result = await method.send({
							from: account.address,
							value: this.bet_amount,
							gas: Math.round(gasNeeded * 2)
						});
					} catch (e) {
						this.wrappers.status.textContent = 'Failed to execute "double".';
					}

					await this.update();
				},

				forfeit : async function() {
					try {
						let method = contract.methods.forfeit();
						let gasNeeded = await method.estimateGas();
						let result = await method.send({
							from: account.address,
							gas: Math.round(gasNeeded * 2)
						});
					} catch (e) {
						this.wrappers.status.textContent = 'Failed to execute "forfeit".';
					}

					await this.update();
				},

				update : async function(justBet=false) {
					await Promise.all([
						this.showHands(),
						this.showBalance()
					]);

					if (this.player_address == '0x0000000000000000000000000000000000000000') {
						if (this.running || justBet) {
							this.running = false;

							let status = 'Game ended.';
							//if (this.balance >= this.new_balance) {
							if (this.last_winner == this.dealer_address) {
								status += ' You lost!';
								this.showResult(false);
							}
							else {
								status += ' You won!';
								this.showResult(true);
							}
							this.wrappers.status.textContent = status;
						}
					}
					else {
						if (!this.running) {
							this.running = true;
							this.wrappers.status.textContent = 'Game started!';
						}
					}

					this.balance = this.new_balance;
				},

				showResult : function(playerWon) {
					let dinfo = document.createElement('div');
					dinfo.className = 'result';
					dinfo.textContent = playerWon ? 'Lost' : 'Won';
					dinfo.style.color = playerWon ? '#dc3545' : '#198754';
					this.wrappers.dealerCards.appendChild(dinfo);

					let pinfo = document.createElement('div');
					pinfo.className = 'result';
					pinfo.textContent = playerWon ? 'Won' : 'Lost';
					pinfo.style.color = playerWon ? '#198754' : '#dc3545';
					this.wrappers.playerCards.appendChild(pinfo);
				},

				getHands : async function() {
					let dealerCards = [];
					let playerCards = [];
					try {
						for (let i = 0; i < 21; i++) {
							card = await contract.methods.dealerCards(i).call();
							dealerCards.push(card.cat + '_' + card.num);
						}
					} catch (e) {}
					try {
						for (let i = 0; i < 21; i++) {
							card = await contract.methods.playerCards(i).call();
							playerCards.push(card.cat + '_' + card.num);
						}
					} catch (e) {}

					this.dealerScore = await contract.methods.dealerScore().call();
					this.playerScore = await contract.methods.playerScore().call();

					this.dealerCards = dealerCards;
					this.playerCards = playerCards;
				},

				showHands : async function() {
					await this.getHands();

					this.wrappers.dealerCards.textContent = '';
					this.wrappers.playerCards.textContent = '';

					this.dealerCards.forEach(card => {
						let img = document.createElement('img');
						img.style.height = '120px';
						img.src = 'static/cards/' + card + '.png';
						this.wrappers.dealerCards.appendChild(img);
					});

					let dinfo = document.createElement('div');
					dinfo.className = 'info';
					dinfo.textContent = `Score: ${this.dealerScore}`;
					this.wrappers.dealerCards.appendChild(dinfo);

					this.playerCards.forEach(card => {
						let img = document.createElement('img');
						img.style.height = '120px';
						img.src = 'static/cards/' + card + '.png';
						this.wrappers.playerCards.appendChild(img);
					});

					let pinfo = document.createElement('div');
					pinfo.className = 'info';
					pinfo.textContent = `Score: ${this.playerScore}`;
					this.wrappers.playerCards.appendChild(pinfo);
				},

				showBalance : async function() {
					this.player_address = await contract.methods.player().call();
					this.dealer_address = await contract.methods.dealer().call();
					this.last_winner = await contract.methods.last_winner().call();

					this.new_balance = Web3.utils.fromWei(
						await web3.eth.getBalance(contract.options.address)
					, 'ether');

					this.wrappers.dealerBalance.textContent = `(${this.new_balance} ether)`;

					
					let address = null;
					if (this.player_address != '0x0000000000000000000000000000000000000000') {
						this.last_player = this.player_address;
					}

					if (this.last_player) {
						let balance = Web3.utils.fromWei(
							await web3.eth.getBalance(this.last_player)
						, 'ether');
						this.wrappers.playerBalance.textContent = `(${balance} ether)`;
					}
				},

			};
			blackjack.init();
		</script>
	</body>
</html>
