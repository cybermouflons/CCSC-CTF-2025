#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void decode(char *enc, char *msg, char* key) {
	size_t len = strlen(enc);
	size_t keylen = strlen(key);
	for (size_t i = 0; i < len; i++) {
		msg[i] = enc[i] ^ key[i % keylen];
	}
	msg[len] = '\0';
}

int main(int argc, char *argv[]) {
	if (argc != 2) {
		printf("[!] Usage: %s <key>\n", argv[0]);
		return 1;
	}
	
	char dynamic_key[] = {0x11, 0x11, 0x11, 0x11, 0x11, 0x00};
	char encrypted_key[] = {0x01, 0x3d, 0x46, 0x8f, 0x9e, 0xba, 0xe9, 0x59, 0x4f, 0xff, 0xcf, 0x56, 0xea, 0xc9, 0x94, 0x5b, 0xe5, 0x83, 0xf6, 0x87, 0xb3, 0x29, 0x11, 0x0c, 0x7a, 0xe0, 0xd7, 0x81, 0xe5, 0x94, 0x9d, 0xc1, 0xe4, 0x57, 0x2e, 0x2d, 0x00}; //{ ... , 0x00};
	char decrypted_key[222];
	char encrypted_flag[] = {0x64, 0x5c, 0x37, 0xea, 0xd5, 0xf0, 0x9e, 0x4e, 0x1d, 0x90, 0xdb, 0x2b, 0xa6, 0xde, 0xe7, 0x48, 0x98, 0xd6, 0xb1, 0xe5, 0xde, 0x54, 0x46, 0x5a, 0x15, 0x83, 0x9d, 0x97, 0xf2, 0x95, 0x8e, 0x8d, 0x81, 0x14, 0x3f, 0x70, 0x00}; //{ ... , 0x00};
	char decrypted_flag[222];

	size_t len = strlen(argv[1]);
	if (len < 5) {
		printf("[!] Input key is too small\n");
		return 0;
	}
	for (int i = 0; i < len; i = i + 5) {
		decode(dynamic_key, dynamic_key, argv[1] + i);	
	}
	decode(encrypted_key, decrypted_key, dynamic_key);
	
	printf("[.] Decrypting ...\n");
	decode(encrypted_flag, decrypted_flag, decrypted_key);
	printf("[.] Here is your flag: %s\n", decrypted_flag);

	return 0;
}
