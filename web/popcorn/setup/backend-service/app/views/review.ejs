<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= movie.title %> – Reviews</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

  <!-- Top Navbar -->
  <div class="navbar">
    <a href="/movies">Home</a>
    <a href="/profile">Profile</a>
  </div>

  <h1 style="text-align: center;"><%= movie.title %></h1>
  <div style="text-align: center;">
    <img src="<%- movie.image %>" alt="<%= movie.title %>" height="315" />
    <iframe width="560" height="315" src="<%= movie.trailer %>" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    <p style="max-width: 600px; margin: 10px auto; color: #242424;"><%= movie.description %></p>
  </div>

  <h2 style="text-align: center;">Reviews:</h2>
  <ul style="list-style-type: none; padding: 0; max-width: 600px; margin: 0 auto; color: #333;">
    <% if (reviews.length === 0) { %>
      <li style="text-align: center;">No reviews yet. Be the first!</li>
    <% } else { %>
      <% reviews.forEach(function(r) { %>
        <div class="review-card">
          <strong><%= r.username %></strong>
          <span><%= r.review %></span>
        </div>
      <% }); %>
    <% } %>
  </ul>

  <h2 style="text-align: center;">Leave a review:</h2>
  <form id="review-form" style="text-align: center; margin-bottom: 20px;">
    <textarea id="review-text" name="review" rows="4" cols="50" placeholder="Write your thoughts here..." required></textarea><br/>
    <p style="text-align: center; font-size: 12px; color: #1d1d1d;">
      ⚠️ Reviews, <b>including any URLs</b>, are monitored by moderators for quality and content.
    </p>
    <button type="submit">Submit</button> 
  </form>



  <div style="text-align: center; margin-top: 20px;">
    <a href="/movies">← Back to movies</a>
  </div>

  <footer style="text-align: center; padding: 20px; color: #242323; font-size: 14px;">
    &copy; CYberMouflons 2025
  </footer>

  <script>
    document.getElementById('review-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const review = document.getElementById('review-text').value.trim();
      const movieId = <%= movie.id %>;

      if (!review) {
        alert("Review cannot be empty");
        return;
      }

      const response = await fetch(`/movies/${movieId}/review`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ review })
      });

      if (response.redirected) {
        window.location.href = response.url;
      } else {
        const result = await response.json();
        alert(result.message || "Something went wrong");
      }
    });
  </script>
</body>
</html>